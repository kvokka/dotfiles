name: ci

on:
  push:
    # The smoke test is testing only chezmoi config, this elliminates waste of resources
    paths:
    - .github/workflows/**
    - homedir/.chezmoiscripts/**
    - homedir/.chezmoi*
    - .chezmoi*
    - bootstrap.sh
  pull_request:
  workflow_dispatch:
    inputs:
      full:
        description: 'Run full installation (same as tagging commit with "full")'
        type: boolean
        default: true

jobs:
  clone-and-install:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/vscode/devcontainers/base:ubuntu-24.04
      env:
        CODESPACES: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Detect full mode
        run: |
          git fetch --tags --force 2>/dev/null || true
          if [ "${{ inputs.full }}" = "true" ] || git tag --points-at HEAD | grep -q '^full$'; then
            echo "CI_FULL=true" >> "$GITHUB_ENV"
            echo "::notice::Running FULL installation"
          else
            echo "::notice::Running LIGHT installation (tag commit with 'full' for complete run)"
          fi

        # CI light mode: install only critical dependencies (brew + mise), brew allows only to skip tools
      - name: Install
        run: |
          if [ "${CI_FULL}" != "true" ]; then
            export MISE_ENABLE_TOOLS="chezmoi,oh-my-posh,zoxide"
            export HOMEBREW_BUNDLE_BREW_SKIP="git curl wget make docker-credential-helper htop ncdu tree diff-so-fancy tig gnupg coreutils"
          fi

          sh -c "$(curl -fsLS get.chezmoi.io/lb)" -- init --apply --force --purge-binary --branch ${{ github.ref_name }} kvokka
      - run: "tree -a -L 2 $HOME"
      - name: smoke test
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          mise --version
          ~/.local/share/mise/shims/chezmoi --version
          ~/.local/share/mise/shims/chezmoi data
