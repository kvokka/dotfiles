#!/usr/bin/env bash

set -eufo pipefail

if ! command -v brew >/dev/null 2>&1; then
  echo "==> Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

mkdir -p ~/.config/zshrc.d

cat << 'EOF' > ~/.config/zshrc.d/010-brew.zsh
# Managed by chezmoi run_once_before_010_install-brew.tmpl â€” do not edit

{{ if eq .chezmoi.os "darwin" }}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ else if eq .chezmoi.os "linux" }}
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{ else }}
echo "Error: Homebrew not supported on OS: {{ .chezmoi.os }} Arch: {{ .chezmoi.arch }}" && exit 1
{{ end }}

BREW_PREFIX=$(brew --prefix)
if [[ -z "${CPPFLAGS:-}" || "${CPPFLAGS:-}" != *"${BREW_PREFIX}/include"* ]]; then
  export CPPFLAGS="${CPPFLAGS:--I${BREW_PREFIX}/include}"
fi
if [[ -z "${LDFLAGS:-}" || "${LDFLAGS:-}" != *"${BREW_PREFIX}/lib"* ]]; then
  export LDFLAGS="${LDFLAGS:--L${BREW_PREFIX}/lib}"
fi
if [[ -z "${PKG_CONFIG_PATH:-}" || "${PKG_CONFIG_PATH:-}" != *"${BREW_PREFIX}/lib/pkgconfig"* ]]; then
  export PKG_CONFIG_PATH="${PKG_CONFIG_PATH:-}${PKG_CONFIG_PATH:+:}${BREW_PREFIX}/lib/pkgconfig"
fi
if [[ -d "${BREW_PREFIX}/bin" && "$PATH" != *"${BREW_PREFIX}/bin"* ]]; then
  export PATH="${BREW_PREFIX}/bin:$PATH"
fi
EOF
